services:
  # ========== RABBITMQ MESSAGE BROKER ==========
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: fitness
      RABBITMQ_DEFAULT_PASS: fitness123
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Kong Database
  kong-database:
    image: postgres:15-alpine
    container_name: kong-database
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
    ports:
      - "5432:5432"
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong -d kong"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Kong Migrations
  kong-migrations:
    image: kong:3.3.1
    container_name: kong-migrations
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - fitness-network
    restart: "no"

  # Kong Gateway
  kong:
    image: kong:3.3.1
    container_name: kong-gateway
    restart: on-failure
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:9000
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_DNS_STALE_TTL: 5
      KONG_DNS_NOT_FOUND_TTL: 1
      KONG_DNS_ERROR_TTL: 1
    ports:
      - "8000:8000"
      - "8001:8001"
      - "8443:8443"
      - "8444:8444"
    networks:
      - fitness-network
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migrations:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB za User Service
  mongo-users:
    image: mongo:7
    container_name: mongo-users
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_users
    volumes:
      - mongo-users-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s
  mongo-group-bookings:
    image: mongo:7
    container_name: mongo-group-bookings
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_group_bookings
    volumes:
      - mongo-group-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  # ========== MICROSERVICES ==========
  # User Service
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    restart: on-failure
    entrypoint: ["/bin/sh", "-c", "sleep 20 && npm start"]
    ports:
      - "3001:3001"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-users:27017/fitness_users?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3001
      NODE_ENV: development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongo-users:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # Subscription Service
  mongo-subscriptions:
    image: mongo:7
    container_name: mongo-subscriptions
    ports:
      - "27019:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_subscriptions
    volumes:
      - mongo-subscriptions-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  subscription-service:
    build:
      context: ./subscription-service
      dockerfile: Dockerfile.dev
    container_name: subscription-service
    restart: on-failure
    entrypoint: ["/bin/sh", "-c", "sleep 20 && dotnet run"]
    ports:
      - "3002:3002"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-subscriptions:27017/fitness-subscriptions?authSource=admin
      DatabaseSettings__ConnectionString: mongodb://admin:admin123@mongo-subscriptions:27017/fitness-subscriptions?authSource=admin
      DatabaseSettings__DatabaseName: fitness-subscriptions
      JWT_SECRET: dev-secret-key
      PORT: 3002
      ASPNETCORE_URLS: http://+:3002
      ASPNETCORE_ENVIRONMENT: Development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongo-subscriptions:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # Trainer Booking Service
  mongo-trainer-bookings:
    image: mongo:7
    container_name: mongo-trainer-bookings
    ports:
      - "27020:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_trainer_bookings
    volumes:
      - mongo-trainer-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  trainer-booking-service:
    build:
      context: ./trainer-booking-service
      dockerfile: Dockerfile.dev
    container_name: trainer-booking-service
    restart: on-failure
    entrypoint: ["/bin/sh", "-c", "sleep 20 && dotnet run"]
    ports:
      - "3003:3003"
    environment:
      DatabaseSettings__ConnectionString: mongodb://admin:admin123@mongo-trainer-bookings:27017/fitness_trainer_bookings?authSource=admin
      DatabaseSettings__DatabaseName: fitness_trainer_bookings
      MONGODB_URI: mongodb://admin:admin123@mongo-trainer-bookings:27017/fitness_trainer_bookings?authSource=admin
      ASPNETCORE_URLS: http://+:3003
      ASPNETCORE_ENVIRONMENT: Development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongo-trainer-bookings:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # Workout Schedule Service
  mongo-workout-schedules:
    image: mongo:7
    container_name: mongo-workout-schedules
    ports:
      - "27021:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_workout_schedules
    volumes:
      - mongo-workout-schedules-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  workout-schedule-service:
    build:
      context: ./workout-schedule-service
      dockerfile: Dockerfile
    container_name: workout-schedule-service
    restart: on-failure
    entrypoint: ["/bin/sh", "-c", "sleep 20 && npm start"]
    ports:
      - "3004:3004"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-workout-schedules:27017/fitness_workout_schedules?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3004
      NODE_ENV: development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongo-workout-schedules:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # Group Class Booking Service
  mongo-group-class-bookings:
    image: mongo:7
    container_name: mongo-group-class-bookings
    ports:
      - "27022:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_group_class_bookings
    volumes:
      - mongo-group-class-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  group-class-booking-service:
    build:
      context: ./group-class-booking-service
      dockerfile: Dockerfile
    container_name: group-class-booking-service
    restart: on-failure
    entrypoint: ["/bin/sh", "-c", "sleep 20 && npm start"]
    ports:
      - "3005:3005"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-group-class-bookings:27017/fitness_group_class_bookings?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3005
      NODE_ENV: development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongo-group-class-bookings:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # Admin Reporting Service
  mongo-admin-reports:
    image: mongo:7
    container_name: mongo-admin-reports
    ports:
      - "27023:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_admin_reports
    volumes:
      - mongo-admin-reports-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  admin-reporting-service:
    build:
      context: ./admin-reporting-service
      dockerfile: Dockerfile
    container_name: admin-reporting-service
    restart: on-failure
    entrypoint: ["/bin/sh", "-c", "sleep 20 && npm start"]
    ports:
      - "3006:3006"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-admin-reports:27017/fitness_admin_reports?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3006
      NODE_ENV: development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongo-admin-reports:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== LOGGING SERVICE ==========
  mongo-logs:
    image: mongo:7
    container_name: mongo-logs
    ports:
      - "27024:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_logs
    volumes:
      - mongo-logs-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  logging-service:
    build:
      context: ./logging-service
      dockerfile: Dockerfile
    container_name: logging-service
    restart: on-failure
    entrypoint: ["/bin/sh", "-c", "sleep 20 && npm start"]
    ports:
      - "3007:3007"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-logs:27017/fitness_logs?authSource=admin
      PORT: 3007
      NODE_ENV: development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongo-logs:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== FRONTEND ==========
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "8080:8080"
    environment:
      VITE_API_URL: http://localhost:8000
    volumes:
      - ../frontend:/app
      - /app/node_modules
    networks:
      - fitness-network

  # Kong Configurator - automatically configures Kong after startup
  kong-configurator:
    image: curlimages/curl:latest
    container_name: kong-configurator
    restart: "no"
    depends_on:
      kong:
        condition: service_healthy
      user-service:
        condition: service_started
      subscription-service:
        condition: service_started
      trainer-booking-service:
        condition: service_started
      workout-schedule-service:
        condition: service_started
      group-class-booking-service:
        condition: service_started
      admin-reporting-service:
        condition: service_started
    networks:
      - fitness-network
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "‚è≥ Waiting 10 seconds for services to fully initialize..."
        sleep 10
        
        echo "üîß Configuring Kong Gateway..."
        
        # Function to create or update Kong service
        configure_service() {
          SERVICE_NAME=$$1
          SERVICE_URL=$$2
          ROUTE_PATH=$$3
          
          echo "üìù Configuring $$SERVICE_NAME..."
          
          # Try to get existing service
          SERVICE_ID=$$(curl -s http://kong-gateway:8001/services/$$SERVICE_NAME | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
          
          if [ -n "$$SERVICE_ID" ]; then
            # Update existing service
            curl -i -X PATCH http://kong-gateway:8001/services/$$SERVICE_NAME \
              --data "url=$$SERVICE_URL" 2>/dev/null | head -n 1
          else
            # Create new service
            curl -i -X POST http://kong-gateway:8001/services/ \
              --data "name=$$SERVICE_NAME" \
              --data "url=$$SERVICE_URL" 2>/dev/null | head -n 1
            
            # Create route for new service
            curl -i -X POST http://kong-gateway:8001/services/$$SERVICE_NAME/routes \
              --data "paths[]=$$ROUTE_PATH" \
              --data "strip_path=false" 2>/dev/null | head -n 1
          fi
        }
        
        # Configure all services
        configure_service "user-service" "http://user-service:3001" "/api/users"
        configure_service "subscription-service" "http://subscription-service:3002" "/api/subscriptions"
        configure_service "trainer-booking-service" "http://trainer-booking-service:3003" "/api/trainers"
        configure_service "workout-schedule-service" "http://workout-schedule-service:3004" "/api/schedules"
        configure_service "group-class-booking-service" "http://group-class-booking-service:3005" "/api/classes"
        configure_service "admin-reporting-service" "http://admin-reporting-service:3006" "/api/admin"
        
        echo "‚úÖ Kong configuration completed!"
        echo "üåê API Gateway ready at http://localhost:8000"

volumes:
  rabbitmq-data:
  kong-db-data:
  mongo-users-data:
  mongo-group-bookings-data:
  mongo-subscriptions-data:
  mongo-trainer-bookings-data:
  mongo-workout-schedules-data:
  mongo-group-class-bookings-data:
  mongo-admin-reports-data:
  mongo-logs-data:
networks:
  fitness-network:
    driver: bridge
