services:
  # Kong Database
  kong-database:
    image: postgres:15-alpine
    container_name: kong-database
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
    ports:
      - "5432:5432"
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong -d kong"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Kong Migrations
  kong-migrations:
    image: kong:3.3.1
    container_name: kong-migrations
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - fitness-network
    restart: on-failure

  # Kong Gateway
  kong:
    image: kong:3.3.1
    container_name: kong-gateway
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:9000
    ports:
      - "8000:8000"
      - "8001:8001"
      - "8443:8443"
      - "8444:8444"
    networks:
      - fitness-network
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migrations:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB za User Service
  mongo-users:
    image: mongo:7
    container_name: mongo-users
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_users
    volumes:
      - mongo-users-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
  mongo-group-bookings:
    image: mongo:7
    container_name: mongo-group-bookings
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_group_bookings
    volumes:
      - mongo-group-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========== MICROSERVICES ==========
  # User Service
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "3001:3001"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-users:27017/fitness_users?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3001
      NODE_ENV: development
    depends_on:
      mongo-users:
        condition: service_healthy
    networks:
      - fitness-network

  # Subscription Service
  mongo-subscriptions:
    image: mongo:7
    container_name: mongo-subscriptions
    ports:
      - "27019:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_subscriptions
    volumes:
      - mongo-subscriptions-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  subscription-service:
    build:
      context: ./subscription-service
      dockerfile: Dockerfile
    container_name: subscription-service
    ports:
      - "3002:3002"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-subscriptions:27017/fitness_subscriptions?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3002
      ASPNETCORE_URLS: http://+:3002
      ASPNETCORE_ENVIRONMENT: Development
      NODE_ENV: development
    depends_on:
      mongo-subscriptions:
        condition: service_healthy
    networks:
      - fitness-network

  # Trainer Booking Service
  mongo-trainer-bookings:
    image: mongo:7
    container_name: mongo-trainer-bookings
    ports:
      - "27020:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_trainer_bookings
    volumes:
      - mongo-trainer-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  trainer-booking-service:
    build:
      context: ./trainer-booking-service
      dockerfile: Dockerfile
    container_name: trainer-booking-service
    ports:
      - "3003:3003"
    environment:
      DatabaseSettings__ConnectionString: mongodb://admin:admin123@mongo-trainer-bookings:27017/fitness_trainer_bookings?authSource=admin
      DatabaseSettings__DatabaseName: fitness_trainer_bookings
      ASPNETCORE_URLS: http://+:3003
      ASPNETCORE_ENVIRONMENT: Development
    depends_on:
      mongo-trainer-bookings:
        condition: service_healthy
    networks:
      - fitness-network

  # Workout Schedule Service
  mongo-workout-schedules:
    image: mongo:7
    container_name: mongo-workout-schedules
    ports:
      - "27021:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_workout_schedules
    volumes:
      - mongo-workout-schedules-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  workout-schedule-service:
    build:
      context: ./workout-schedule-service
      dockerfile: Dockerfile
    container_name: workout-schedule-service
    ports:
      - "3004:3004"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-workout-schedules:27017/fitness_workout_schedules?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3004
      NODE_ENV: development
    depends_on:
      mongo-workout-schedules:
        condition: service_healthy
    networks:
      - fitness-network

  # Group Class Booking Service
  mongo-group-class-bookings:
    image: mongo:7
    container_name: mongo-group-class-bookings
    ports:
      - "27022:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_group_class_bookings
    volumes:
      - mongo-group-class-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  group-class-booking-service:
    build:
      context: ./group-class-booking-service
      dockerfile: Dockerfile
    container_name: group-class-booking-service
    ports:
      - "3005:3005"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-group-class-bookings:27017/fitness_group_class_bookings?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3005
      NODE_ENV: development
    depends_on:
      mongo-group-class-bookings:
        condition: service_healthy
    networks:
      - fitness-network

  # Admin Reporting Service
  mongo-admin-reports:
    image: mongo:7
    container_name: mongo-admin-reports
    ports:
      - "27023:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: fitness_admin_reports
    volumes:
      - mongo-admin-reports-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  admin-reporting-service:
    build:
      context: ./admin-reporting-service
      dockerfile: Dockerfile
    container_name: admin-reporting-service
    ports:
      - "3006:3006"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongo-admin-reports:27017/fitness_admin_reports?authSource=admin
      JWT_SECRET: dev-secret-key
      PORT: 3006
      NODE_ENV: development
    depends_on:
      mongo-admin-reports:
        condition: service_healthy
    networks:
      - fitness-network

volumes:
  kong-db-data:
  mongo-users-data:
  mongo-group-bookings-data:
  mongo-subscriptions-data:
  mongo-trainer-bookings-data:
  mongo-workout-schedules-data:
  mongo-group-class-bookings-data:
  mongo-admin-reports-data:
networks:
  fitness-network:
    driver: bridge
