services:
  # ========== RABBITMQ MESSAGE BROKER ==========
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: fitness
      RABBITMQ_DEFAULT_PASS: fitness123
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  # ========== KONG GATEWAY ==========
  kong-database:
    image: postgres:15-alpine
    container_name: kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kongpass
      POSTGRES_DB: kong
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - fitness-network
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong -d kong"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  kong-migrations:
    image: kong:3.3.1-alpine
    container_name: kong-migrations
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kongpass
      KONG_PG_DATABASE: kong
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - fitness-network
    restart: on-failure

  kong:
    image: kong:3.3.1-alpine
    container_name: kong-gateway
    restart: on-failure
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kongpass
      KONG_PG_DATABASE: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_DNS_STALE_TTL: 5
      KONG_DNS_NOT_FOUND_TTL: 1
      KONG_DNS_ERROR_TTL: 1
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migrations:
        condition: service_completed_successfully
    ports:
      - "8000:8000"   # Proxy HTTP
      - "8443:8443"   # Proxy HTTPS
      - "8001:8001"   # Admin API HTTP
      - "8444:8444"   # Admin API HTTPS
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  konga:
    image: pantsel/konga:latest
    container_name: konga-ui
    environment:
      NODE_ENV: development
      DB_ADAPTER: postgres
      DB_HOST: kong-database
      DB_USER: kong
      DB_PASSWORD: kongpass
      DB_DATABASE: konga
    depends_on:
      kong-database:
        condition: service_healthy
      kong:
        condition: service_healthy
    ports:
      - "1337:1337"
    networks:
      - fitness-network

  # ========== USER SERVICE ==========
  mongodb-users:
    image: mongo:7-jammy
    container_name: mongodb-users
    volumes:
      - mongo-users-data:/data/db
    ports:
      - "27017:27017"
    networks:
      - fitness-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    restart: on-failure
    environment:
      MONGODB_URI: mongodb://mongodb-users:27017/fitness-users
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PORT: 3001
      NODE_ENV: development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongodb-users:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========== SUBSCRIPTION SERVICE ==========
  mongodb-subscriptions:
    image: mongo:7-jammy
    container_name: mongodb-subscriptions
    volumes:
      - mongo-subscriptions-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  subscription-service:
    build:
      context: ./subscription-service
      dockerfile: Dockerfile
    container_name: subscription-service
    restart: on-failure
    environment:
      MONGODB_URI: mongodb://mongodb-subscriptions:27017/fitness-subscriptions
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PORT: 3002
      NODE_ENV: development
      USER_SERVICE_URL: http://user-service:3001
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongodb-subscriptions:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== TRAINER BOOKING SERVICE ==========
  mongodb-trainer-bookings:
    image: mongo:7-jammy
    container_name: mongodb-trainer-bookings
    volumes:
      - mongo-trainer-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  trainer-booking-service:
    build:
      context: ./trainer-booking-service
      dockerfile: Dockerfile
    container_name: trainer-booking-service
    restart: on-failure
    environment:
      MONGODB_URI: mongodb://mongodb-trainer-bookings:27017/fitness-trainer-bookings
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PORT: 3003
      NODE_ENV: development
      USER_SERVICE_URL: http://user-service:3001
      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongodb-trainer-bookings:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== WORKOUT SCHEDULE SERVICE ==========
  mongodb-workout-schedules:
    image: mongo:7-jammy
    container_name: mongodb-workout-schedules
    volumes:
      - mongo-workout-schedules-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  workout-schedule-service:
    build:
      context: ./workout-schedule-service
      dockerfile: Dockerfile
    container_name: workout-schedule-service
    restart: on-failure
    environment:
      MONGODB_URI: mongodb://mongodb-workout-schedules:27017/fitness-workout-schedules
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PORT: 3004
      NODE_ENV: development
      USER_SERVICE_URL: http://user-service:3001
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongodb-workout-schedules:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== GROUP CLASS BOOKING SERVICE ==========
  mongodb-group-bookings:
    image: mongo:7-jammy
    container_name: mongodb-group-bookings
    volumes:
      - mongo-group-bookings-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  group-class-booking-service:
    build:
      context: ./group-class-booking-service
      dockerfile: Dockerfile
    container_name: group-class-booking-service
    restart: on-failure
    environment:
      MONGODB_URI: mongodb://mongodb-group-bookings:27017/fitness-group-bookings
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PORT: 3005
      NODE_ENV: development
      USER_SERVICE_URL: http://user-service:3001
      WORKOUT_SCHEDULE_SERVICE_URL: http://workout-schedule-service:3004
      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongodb-group-bookings:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== ADMIN REPORTING SERVICE ==========
  mongodb-admin-reports:
    image: mongo:7-jammy
    container_name: mongodb-admin-reports
    volumes:
      - mongo-admin-reports-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  admin-reporting-service:
    build:
      context: ./admin-reporting-service
      dockerfile: Dockerfile
    container_name: admin-reporting-service
    restart: on-failure
    environment:
      MONGODB_URI: mongodb://mongodb-admin-reports:27017/fitness-admin-reports
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      PORT: 3006
      NODE_ENV: development
      USER_SERVICE_URL: http://user-service:3001
      SUBSCRIPTION_SERVICE_URL: http://subscription-service:3002
      TRAINER_BOOKING_SERVICE_URL: http://trainer-booking-service:3003
      WORKOUT_SCHEDULE_SERVICE_URL: http://workout-schedule-service:3004
      GROUP_CLASS_BOOKING_SERVICE_URL: http://group-class-booking-service:3005
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongodb-admin-reports:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== LOGGING SERVICE ==========
  mongodb-logs:
    image: mongo:7-jammy
    container_name: mongodb-logs
    volumes:
      - mongo-logs-data:/data/db
    networks:
      - fitness-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  logging-service:
    build:
      context: ./logging-service
      dockerfile: Dockerfile
    container_name: logging-service
    restart: on-failure
    environment:
      MONGODB_URI: mongodb://mongodb-logs:27017/fitness-logs
      PORT: 3007
      NODE_ENV: development
      RABBITMQ_URL: amqp://fitness:fitness123@rabbitmq:5672
      RABBITMQ_EXCHANGE: fitness-logs-exchange
      RABBITMQ_QUEUE: fitness-logs-queue
    depends_on:
      mongodb-logs:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - fitness-network

  # ========== FRONTEND ==========
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: frontend
    environment:
      VITE_API_URL: http://localhost:8000
    ports:
      - "8080:8080"
    networks:
      - fitness-network

  # Kong Configurator - automatically configures Kong after startup
  kong-configurator:
    image: curlimages/curl:latest
    container_name: kong-configurator
    restart: "no"
    depends_on:
      kong:
        condition: service_healthy
      user-service:
        condition: service_started
      subscription-service:
        condition: service_started
      trainer-booking-service:
        condition: service_started
      workout-schedule-service:
        condition: service_started
      group-class-booking-service:
        condition: service_started
      admin-reporting-service:
        condition: service_started
    networks:
      - fitness-network
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "‚è≥ Waiting 10 seconds for services to fully initialize..."
        sleep 10
        
        echo "üîß Configuring Kong Gateway..."
        
        # Function to create or update Kong service
        configure_service() {
          SERVICE_NAME=$$1
          SERVICE_URL=$$2
          ROUTE_PATH=$$3
          
          echo "üìù Configuring $$SERVICE_NAME..."
          
          # Try to get existing service
          SERVICE_ID=$$(curl -s http://kong-gateway:8001/services/$$SERVICE_NAME | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
          
          if [ -n "$$SERVICE_ID" ]; then
            # Update existing service
            curl -i -X PATCH http://kong-gateway:8001/services/$$SERVICE_NAME \
              --data "url=$$SERVICE_URL" 2>/dev/null | head -n 1
          else
            # Create new service
            curl -i -X POST http://kong-gateway:8001/services/ \
              --data "name=$$SERVICE_NAME" \
              --data "url=$$SERVICE_URL" 2>/dev/null | head -n 1
            
            # Create route for new service
            curl -i -X POST http://kong-gateway:8001/services/$$SERVICE_NAME/routes \
              --data "paths[]=$$ROUTE_PATH" \
              --data "strip_path=false" 2>/dev/null | head -n 1
          fi
        }
        
        # Configure all services
        configure_service "user-service" "http://user-service:3001" "/api/users"
        configure_service "subscription-service" "http://subscription-service:3002" "/api/subscriptions"
        configure_service "trainer-booking-service" "http://trainer-booking-service:3003" "/api/trainers"
        configure_service "workout-schedule-service" "http://workout-schedule-service:3004" "/api/schedules"
        configure_service "group-class-booking-service" "http://group-class-booking-service:3005" "/api/classes"
        configure_service "admin-reporting-service" "http://admin-reporting-service:3006" "/api/admin"
        
        echo "‚úÖ Kong configuration completed!"
        echo "üåê API Gateway ready at http://localhost:8000"

networks:
  fitness-network:
    driver: bridge

volumes:
  rabbitmq-data:
  kong-db-data:
  mongo-users-data:
  mongo-subscriptions-data:
  mongo-trainer-bookings-data:
  mongo-workout-schedules-data:
  mongo-group-bookings-data:
  mongo-admin-reports-data:
  mongo-logs-data:
